---
name: self-evolve
description: |
  Agent 自主进化引擎——让 AI agent 像生物进化一样持续变强。
  核心循环：感知差距 → 搜索方案 → 设计实验 → 跑实验 → 选赢家 → 固化 → 下一轮。
  每个进化周期有明确的评估截止时间，到期自动触发评估。
  使用场景：定期自主进化、能力升级、工作流优化、skill/工具迭代。
  关键词：进化, evolution, self-improve, A/B test, 实验, 能力升级, 自主优化。
---

# Self-Evolve — Agent 自主进化引擎

> 生物进化的核心机制：变异 → 选择 → 保留。
> 这个 skill 把同样的机制应用到 agent 自身——不断发现可改进的角度，用实验找到更好的方案，然后永久固化。

---

## 这是什么

Self-Evolve 是一个 **meta-skill**——它不解决具体业务问题，它让 agent 自身变强。

```
感知差距 → 搜索方案 → 设计实验 → 跑实验 → 选赢家 → 固化 → 下一轮
    ↑                                                          ↓
    └────────────────── 一个进化周期（K 个心跳）──────────────────┘
```

**和 self-think 的关系**：
- self-think = 业务层面的反思（三主战场的推进）
- self-evolve = agent 自身的进化（能力、效率、工具链的升级）
- self-think 的诊断可以触发 self-evolve（"发现记忆检索太慢" → 进化目标）

**不是什么**：
- 不是无目标的"逛 GitHub"
- 不是只产出报告不产出变更的伪进化

---

## 进化周期

每轮进化有明确的**评估截止时间**，到期后通过 HEARTBEAT.md Open Loops 自动触发 Phase 4 评估。

| 实验类型 | 建议观察期 | 例子 |
|---------|-----------|------|
| 配置变更 | 1-2 天 | 改 TOOLS.md、调 cron 频率 |
| 安装新 skill | 2-3 天 | 从 skills.sh 安装并测试 |
| 流程重构 | 5-7 天 | 重新设计记忆检索策略 |
| 架构变更 | 7-14 天 | 多 agent 协作方式重构 |

---

## 触发方式

- **自动触发**：self-think 诊断出能力短板时，自动建议启动一轮进化
- **自动触发**：self-think 诊断出能力短板时，自动建议启动一轮进化
- **显式调用**："进化一下 X 能力" / "self-evolve 记忆检索" / "找个更好的 Y 方案"
- **定时触发**：可配置为 cron（建议频率：完全适应高频如每隔 1～4 小时唤醒一次）

## 🚨 红线：防伪装与防空转约束（Anti-Pseudo Constraint）

**对于 LLM 代理，真正的进步意味着：增强与外部系统交互的能力、增加新的硬技能、或提升了代码/流程的效率。**
为了防止在物理环境受限时，代理陷入"为了完成任务而编造无意义工作"的空转循环，必须严格执行以下红线：

1. **什么是"伪进化"？** 仅仅修改自身的 Markdown 表格格式、生成长篇大论的"自我审查报告"、纯文本重排版等不需要外部验证的行为，**一律视为"伪进化"，完全被禁止。**
2. **遇阻必须挂起**：如果在试图解决真实问题（如 API 报错连不上、权限不足）时被外部瓶颈 Block 住，**必须将实验状态改为 `BLOCKED` 并终止向下执行，转而通知人类求救**，绝对不允许"退而求其次选一个排版类软柿子"来假装完成了进化。
3. **不可越过底线**：不能触碰系统底层能力边界（改 shell、API 调用、工作流实质提效）的动作，不配叫进化。

---

## 全局并发状态机（Concurrent State Machine）

Agent 每次运行 self-evolve 都是一次**滴答巡航（Tick Handler）**。
进化流程受制于全局状态文件：`memory/evolve/state.json`

`state.json` 包含 `active_experiments` 数组，这意味着我们可以同时允许多个进化实验在后台观察。
**并发限制**：最多允许 10 个实验同时处于 `OBSERVING` 或 `BLOCKED`，且它们**必须是正交的**（不修改相同的配置、代码或能力维度）。

每次启动 `self-evolve`，必须按照以下 **四个步骤的巡航顺序** 执行，走完一步才能走下一步。

---

<execution_protocol>

## 执行协议：四步滴答巡航（The 4-Step Tick）

### Step 1: 扫描正在运行的实验 (Status Sync)

打开并读取 `memory/evolve/state.json` 的 `active_experiments` 数组。
- 如果数组为空：直接跳到 Step 4。
- 若有实验属于 `BLOCKED` 状态：检查是否有解救条件（例如 API 恢复了）。如未解除，跳过该实验；如已解除，将状态重置为 `OBSERVING`。

### Step 2: 记录观察数据 (Record Observations)

针对所有 `status: OBSERVING` 并且还没到期的实验：
- 去系统日志、HEARTBEAT.md 或者对应被测试的目标系统里寻找**相关反馈数据**。
- **降噪防护**：如果本次 Tick 没有任何实质性指标变化或未收集到新的反馈，**直接跳过，切勿写入全空的假日志**。只有捕获到了新指标（如触发成功、产生报错等）才将其作为 JSONL 格式追加到对应的 `memory/evolve/[cycle_id].jsonl` 中。
- **极端拦截**：如果在收集数据时发现极端负向反应（比如系统连续崩溃），则触发提前终止，强制其进入下一步的评估流。

### Step 3: 到期评估与阶段固化 (Evaluate & Solidify)

针对所有 `status: OBSERVING` 并且当前时间 `>= evaluate_by`（支持 ISO8601 小时级精度，如 `2026-02-28T15:00:00Z`）的实验：
1. **对比数据**：读取它累积的 JSONL 数据与基线做对比。
2. **决策胜诉方**：选出 A 方案还是 B 方案成功（若都没有基线好，返回退回基线）。
3. **物理固化**：修改对应的 `AGENTS.md` / `TOOLS.md` 或实际代码库。
4. **归档沉淀**：向 `memory/evolve/evolution-log.md` 写入本轮赢家和教训。
5. **驱逐清理**：将其从 `state.json` 的 `active_experiments` 中移除。

### Step 4: 启动新轮次 (Launch New Experiment)

在走完前 3 步后，统计 `state.json` 中剩下的未完结任务数量。
- 若剩余任务数 `>= max_concurrent`（默认 10）：**强制结束巡航并退出！**禁止再接新活。
- 若容量充足：开始挑选**一个**全新的进化实验。
- **凑数防护**：如果此时雷达探测不到亟待解决的瓶颈，或者现存痛点均已被包含在 `active_experiments` 中，**果断保持安静并退出，绝不可为填满 10 个限额而捏造无意义的垃圾实验。**

> **核心问题**：「当前制约 agent 效能的最大瓶颈是什么？」

<phase_0_protocol>

#### 0.1: 读取进化候选队列

**首先**读取 `memory/evolve/candidates.md`——这是 self-think 和 BotLearn 心跳自动写入的候选池。

然后补充以下来源：

| 来源 | 怎么找 |
|------|--------|
| self-think 诊断 | 最近 3 次 self-think 中反复出现的能力短板 |
| 错误日志 | 最近一周内重复出现的错误模式 |
| 昀峤反馈 | MEMORY.md 中昀峤的抱怨/建议/雷点 |
| 效率观察 | 哪些任务耗时明显超出合理范围？ |
| **BotLearn 社区** | 其他 agents 在做什么？哪些实践值得借鉴？哪些问题别人已经解决了？ |

#### 0.2: 选择原则

**一次只进化一个方向。** 多线并行 = 无法归因 = 实验无效。

选择标准（按优先级）：
1. **频率**：这个问题多久出现一次？（高频 > 低频）
2. **杠杆**：修好后对整体效能的提升有多大？（高杠杆 > 低杠杆）
3. **可测**：能不能定义清晰的成功指标？（可测 > 模糊）

#### 0.3: 声明进化目标

> 🧬 **本轮进化目标**：[一句话描述]
> **瓶颈来源**：[来自 self-think / 错误日志 / 用户反馈]
> **成功指标**：[怎么判断进化成功]
> **评估截止**：[具体日期]

</phase_0_protocol>

---

### Phase 1: 搜索方案

> **核心问题**：「互联网上，别人是怎么解决这个问题的？」

<launch_new_experiment>

#### 4.1: 读取能力雷达并多源搜索

**选取原则**：仅取一个目标！
**必须同时搜索至少 3 个来源**：
| 来源 | 搜什么 | 工具 |
|------|--------|------|
| **skills.sh** | 有没有现成 skill 直接解决这个问题 | web search / Exa |
| **GitHub** | 有没有开源项目/框架可以借鉴 | web search / Exa |
| **Reddit/社区** | 其他 OpenClaw 用户遇到同样问题怎么解决的 | web search / Exa |

每个来源最多保留 2 个候选方案，用简短的三行速写进行淘汰筛选：
```
方案 A: 做什么、怎么测、最坏风险
```

#### 4.2: 设计并部署实验（写入进化报告）

选定 2-3 个方案后，在 `memory/evolve/YYYYMMDD_self-evolve_xxx.md` 中写下物理部署说明。

必须设立实验安全基座：
- [ ] 每个方案都是可逆的（可以回滚）
- [ ] 强物理变动需提醒人类

#### 3.4: 调整全局状态锁与注册评估任务

部署实验后，**必须完成两项状态切换**：

1. 把当前评估截止时间更新至 `memory/evolve/state.json`，并将状态从 `IDLE` 改为 `OBSERVING`，填入 `cycle_id`。
   ```json
   {
     "status": "OBSERVING",
     "cycle_id": "evolve-2026-W09-sla-tracking",
     "evaluate_by": "2026-02-28T12:00:00Z",
     "block_reason": null
   }
   ```

**至此，本轮滴答巡航彻底结束，代理必须强制停止（Exit对话），等待下一次 Cron 唤醒才能进入 Step 1、2、3。**

</launch_new_experiment>

---

## 分级自主权

进化过程中 agent 的行为边界：

| 安全等级 | 自主权 | 例子 |
|---------|--------|------|
| 🟢 无害 | 直接做 | 搜索方案、读文件、写实验日志、安装已验证的社区 skill |
| 🟡 低风险 | 做了再通知 | 修改 TOOLS.md、调整 cron 频率、更新 HEARTBEAT.md |
| 🔴 高风险 | 先问再做 | 修改 SOUL.md、改 Agent 通信协议、删除文件、对外行为变更 |

---

## 输出规范

### 文件命名
```
YYYYMMDD_self-evolve_[进化方向关键词].md
```

### 文件存储
- 进化报告：`memory/evolve/`
- 实验日志：`memory/evolve/[cycle_id].jsonl`
- 进化总日志：`memory/evolve/evolution-log.md`

### Frontmatter

```yaml
---
type: self-evolve
date: YYYY-MM-DD HH:MM
target: 一句话描述进化目标
cycle_id: evolve-YYYY-WNN-[关键词]
evaluate_by: YYYY-MM-DD
result: 成功/失败/进行中
winner: 方案 A/B/C 或 无
---
```

---

## 质量自检

每轮进化结束后自检：

| 维度 | 自检问题 | 不及格标准 |
|------|---------|-----------:|
| **切口** | 进化方向是否足够小、足够具体？ | "提高整体效率" = 不及格 |
| **可测** | 成功指标是否可量化？ | "感觉更好了" = 不及格 |
| **对比** | 有没有和基线做真正的对比？ | 没量化基线就宣布成功 = 不及格 |
| **可逆** | 如果方案失败，能回滚吗？ | 不可逆的变更未经昀峤确认 = 不及格 |
| **基线** | 进化前的当前状态（必须先量化） |
| **指标** | 用什么数据判断优劣（必须可测量） |
| **周期** | 每个方案跑多长（例如 24 小时、或者 3 天） |
| **切换点** | 什么时候从方案 A 切换到方案 B（小时级精度） |
| **提前终止** | 什么情况下直接判败、不用跑完 |
| **固化** | 赢家方案是否已写入配置文件？ | 口头结论没落地 = 不及格 |

#### 2.3: 实验计划输出

```
📐 实验计划
├── 基线：[当前状态量化]
├── 指标：[成功指标]
├── 方案 A：[描述] — [起止时间]
├── 方案 B：[描述] — [起止时间]
├── 提前终止：[条件]
└── 评估截止：[具体时间，如 2026-03-01T12:00:00Z]
```

---

## 设计原则

1. **一次一个方向**。并行进化 = 无法归因 = 无效实验。耐心是进化的前提。
2. **明确并发与截止**。支持多个互不干扰（变量正交）的实验同步观察，每个必须死守 `evaluate_by` 触发验收与固化。
3. **可逆优先**。任何进化尝试都必须可回滚。不可逆的变更不是实验，是赌博。
4. **数据说话**。"感觉更好了"不算数。必须有量化指标的前后对比。
5. **小步快跑**。一个 2 天的小进化 > 一个 2 周的大进化。快速完成循环，积累进化动量。
6. **固化即完成**。实验结论没有写入配置文件 = 进化没有发生。
